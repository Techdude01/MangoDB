{% extends "base.html" %}

{% block style %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='./css/style.css') }}">
{% endblock %}

{% block title %}
Mango Homepage
{% endblock %}

{% block body %}
<div class="main">
    <!-- Login Button -->
    {% if show_login_button %}
    <a href="{{ url_for('login') }}" class="button">Go to Login</a>
    {% endif %}

    <!-- Search Section -->
    <div class="main-query">
        <h1>Search Bar</h1>
        <h3>Query by Username, Keyword in Question Text, or Tag!</h3>
        <form id="search-form" action="{{ url_for('search') }}" method="get">
            <div>
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" placeholder="Enter username">
            </div>
            <div>
                <label for="keyword">Keyword:</label>
                <input type="text" id="keyword" name="keyword" placeholder="Enter keyword in question text">
            </div>
            <div>
                <label for="tag">Tag:</label>
                <input type="text" id="tag" name="tag" placeholder="Enter tag name">
            </div>
            <div>
                <button onclick="validateSearchForm()" class="action-btn">Search</button>
            </div>
        </form>
    </div>

    <!-- Post Question Section -->
    <div class="post-question">
        <button id="post-question-btn" onclick="toggleQuestionForm()">Post a Question</button>
        <div id="question-form" style="display: none;">
            <!-- First form to start a draft question -->
            <form id="start-question-form" action="{{ url_for('start_question') }}" method="post">
                <input type="hidden" name="userID" value="{{ session.get('userID', '') }}">
                <div>
                    <label for="question-text">Question:</label>
                    <textarea id="question-text" name="question_text" placeholder="Write your question here..."
                        required></textarea>
                </div>
                <button type="button" onclick="startDraft(event)">Start Draft</button>
            </form>

            <!-- Form to publish the question with tags (shows after draft creation) -->
            <form id="publish-question-form" action="{{ url_for('publish_question')}}" method="post"
                style="display: none;">
                <div>
                    <label for="tags">Tags:</label>
                    <select id="tags" name="tags" multiple required>
                        {% for tag in tags %}
                        <option value="{{ tag['tagID'] }}">{{ tag['tagName'] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit">Publish Question</button>
                <button type="button" onclick="cancelDraft()" id="cancel-question-btn">Cancel</button>
            </form>
            <!-- Hidden form to cancel the question draft -->
            <form id="cancel-question-form" action="{{ url_for('cancel_question')}}" method="post"
                style="display: none;">
                <input type="hidden" name="draft_id" id="cancel-draft-id">
            </form>
        </div>
    </div>

    <!-- Most Popular Questions Section -->
    <div>
        <h2 class=" section-heading"><a href="{{ url_for('most_popular') }}">Most Popular</a></h2>
        <ul class="question-list">
            {% for question in most_popular %}
            {% if question['questionID'] is defined and question['questionText'] is defined %}
            <li class="question-item">
                <a href="{{ url_for('question_detail', question_id=question['questionID']) }}" class="question-link">
                    {{ question['questionText'] }}
                </a>

            </li>
            {% endif %}
            {% endfor %}
        </ul>
        <div class="pagination">
            {% if most_popular_page > 1 %}
            <a href="{{ url_for('most_popular', page=most_popular_page-1) }}">Previous</a>
            {% endif %}
            <span>Page {{ most_popular_page }} of {{ total_pages }}</span>
            {% if most_popular_page < total_pages %} <a href="{{ url_for('most_popular', page=most_popular_page+1) }}">
                Next</a>
                {% endif %}
        </div>
    </div>

    <!-- Most Controversial Questions Section -->
    <div>
        <h2 class="section-heading"><a href="{{ url_for('most_controversial') }}">Most Controversial</a></h2>
        <ul class="question-list">
            {% for question in most_controversial %}
            {% if question['questionID'] is defined and question['questionText'] is defined %}
            <li class="question-item">
                <a href="{{ url_for('question_detail', question_id=question['questionID']) }}" class="question-link">
                    {{ question['questionText'] }}
                </a>
            </li>
            {% endif %}
            {% endfor %}
        </ul>
        <div class="pagination">
            {% if most_controversial_page > 1 %}
            <a href="{{ url_for('most_controversial', page=most_controversial_page-1) }}">Previous</a>
            {% endif %}
            <span>Page {{ most_controversial_page }} of {{ total_pages }}</span>
            {% if most_controversial_page < total_pages %} <a
                href="{{ url_for('most_controversial', page=most_controversial_page+1) }}">Next</a>
                {% endif %}
        </div>
    </div>

    <!-- Most Recent Questions Section -->
    <div>
        <h2 class="section-heading"><a href="{{ url_for('most_recent') }}">Most Recent</a></h2>
        <ul class="question-list">
            {% for question in most_recent %}
            {% if question['questionID'] is defined and question['questionText'] is defined %}
            <li class="question-item">
                <a href="{{ url_for('question_detail', question_id=question['questionID']) }}" class="question-link">
                    {{ question['questionText'] }}
                </a>
            </li>
            {% endif %}
            {% endfor %}
        </ul>
        <div class="pagination">
            {% if most_recent_page > 1 %}
            <a href="{{ url_for('most_recent', page=most_recent_page-1) }}">Previous</a>
            {% endif %}
            <span>Page {{ most_recent_page }} of {{ total_pages }}</span>
            {% if most_recent_page < total_pages %} <a href="{{ url_for('most_recent', page=most_recent_page+1) }}">
                Next</a>
                {% endif %}
        </div>
    </div>

    <!-- ... rest of the file ... -->
</div>

<!-- JavaScript -->
<script>
    function validateSearchForm() {
        var username = document.getElementById("username").value;
        var keyword = document.getElementById("keyword").value;
        var tag = document.getElementById("tag").value;
        if (!username && !keyword && !tag) {
            alert("Please enter either a Username, Keyword, or Tag to search.");
            return false;
        }
        document.getElementById("search-form").submit();
    }

    function toggleQuestionForm() {
        const form = document.getElementById('question-form');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function startDraft(event) {
        event.preventDefault();
        const form = document.getElementById('start-question-form');
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (response.ok) {
                    return response.headers.get('content-type').includes('application/json') ?
                        response.json() :
                        { success: true };
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                // Hide the start draft form
                document.getElementById('start-question-form').style.display = 'none';
                // Show the publish form
                document.getElementById('publish-question-form').style.display = 'block';
                document.getElementById('cancel-question-form').style.display = 'block';
                // You might want to store the draft ID if returned from backend
                if (data && data.draftId) {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'draft_id';
                    hiddenInput.value = data.draftId;
                    document.getElementById('publish-question-form').appendChild(hiddenInput);
                    document.getElementById('cancel-draft-id').value = data.draftId;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to create draft. Please try again.');
            });
    }

    function cancelDraft() {
        document.getElementById('cancel-question-form').submit();
    }
</script>
{% endblock %}